---
description: 
globs: 
alwaysApply: false
---
# ìë™í™” ë„êµ¬ ì‹œìŠ¤í…œ (ADVANCED)

## ğŸ”§ ìŠ¤í¬ë¦½íŠ¸ ìë™í™” ê·œì¹™

### ìŠ¤í¬ë¦½íŠ¸ ë„¤ì´ë° ë° ë¶„ë¥˜
```python
SCRIPT_CATEGORIES = {
    'setup': {
        'prefix': 'setup_',
        'purpose': 'ê°œë°œ í™˜ê²½ ì„¤ì • ë° ì´ˆê¸°í™”',
        'location': 'scripts/setup/',
        'examples': ['setup_coding_tools.py', 'setup_git_hooks.py', 'setup_environment.py']
    },
    'check': {
        'prefix': 'check_',
        'purpose': 'ì½”ë“œ í’ˆì§ˆ ë° ê·œì¹™ ê²€ì¦',
        'location': 'scripts/validation/',
        'examples': ['check_code_style.py', 'check_dependencies.py', 'check_security.py']
    },
    'validate': {
        'prefix': 'validate_',
        'purpose': 'ë°ì´í„° ë° ì„¤ì • ê²€ì¦',
        'location': 'scripts/validation/',
        'examples': ['validate_rules.py', 'validate_config.py', 'validate_data.py']
    },
    'generate': {
        'prefix': 'generate_',
        'purpose': 'íŒŒì¼ ë° ì½”ë“œ ìƒì„±',
        'location': 'scripts/development/',
        'examples': ['generate_docs.py', 'generate_config.py', 'generate_templates.py']
    },
    'deploy': {
        'prefix': 'deploy_',
        'purpose': 'ë°°í¬ ë° ë¦´ë¦¬ì¦ˆ',
        'location': 'scripts/deployment/',
        'examples': ['deploy_staging.py', 'deploy_production.py', 'deploy_docs.py']
    },
    'download': {
        'prefix': 'download_',
        'purpose': 'ëª¨ë¸ ë° ë¦¬ì†ŒìŠ¤ ë‹¤ìš´ë¡œë“œ',
        'location': 'scripts/development/model_management/',
        'examples': ['download_models.py', 'download_opencv_cascades.py', 'download_datasets.py']
    },
    'cleanup': {
        'prefix': 'cleanup_',
        'purpose': 'ì •ë¦¬ ë° ìµœì í™”',
        'location': 'scripts/maintenance/',
        'examples': ['cleanup_models.py', 'cleanup_weights.py', 'cleanup_temp_files.py']
    }
}
```

### ëª¨ë¸ ê´€ë¦¬ ìë™í™”
```python
# scripts/development/model_management/ êµ¬í˜„ í‘œì¤€
MODEL_MANAGEMENT_TASKS = {
    'download_models': {
        'description': 'ëª¨ë¸ ê°€ì¤‘ì¹˜ íŒŒì¼ ë‹¤ìš´ë¡œë“œ',
        'script': 'download_models.py',
        'config_key': 'model_urls'
    },
    'download_opencv_cascades': {
        'description': 'OpenCV Haar Cascade íŒŒì¼ ë‹¤ìš´ë¡œë“œ',
        'script': 'download_opencv_cascades.py',
        'config_key': 'cascade_urls'
    },
    'generate_metadata': {
        'description': 'ëª¨ë¸ ë©”íƒ€ë°ì´í„° ìƒì„±',
        'script': 'generate_model_metadata.py',
        'config_key': 'metadata_config'
    },
    'validate_metadata': {
        'description': 'ëª¨ë¸ ë©”íƒ€ë°ì´í„° ê²€ì¦',
        'script': 'validate_model_metadata.py',
        'config_key': 'validation_config'
    },
    'cleanup_models': {
        'description': 'ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ëª¨ë¸ ì •ë¦¬',
        'script': 'cleanup_models.py',
        'config_key': 'cleanup_config'
    },
    'restructure_models': {
        'description': 'ëª¨ë¸ ë””ë ‰í† ë¦¬ êµ¬ì¡° ì¬ì •ë¦¬',
        'script': 'restructure_models.py',
        'config_key': 'restructure_config'
    }
}

def run_model_management_task(task_name, config_file=None):
    """ëª¨ë¸ ê´€ë¦¬ ì‘ì—… ì‹¤í–‰"""
    if task_name not in MODEL_MANAGEMENT_TASKS:
        raise ValueError(f"Unknown task: {task_name}")
    
    task_config = MODEL_MANAGEMENT_TASKS[task_name]
    script_path = f"scripts/development/model_management/{task_config['script']}"
    
    if not os.path.exists(script_path):
        raise FileNotFoundError(f"Script not found: {script_path}")
    
    # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    cmd = [sys.executable, script_path]
    if config_file:
        cmd.extend(['--config', config_file])
    
    result = subprocess.run(cmd, capture_output=True, text=True)
    
    return {
        'returncode': result.returncode,
        'stdout': result.stdout,
        'stderr': result.stderr,
        'success': result.returncode == 0
    }
```

## ğŸ“Š ë°ì´í„°ì…‹ ê´€ë¦¬ ìë™í™”

### ë°ì´í„°ì…‹ íŒŒì´í”„ë¼ì¸ ìë™í™”
```python
# scripts/development/dataset_pipeline.py êµ¬í˜„ í‘œì¤€
DATASET_PIPELINE_STAGES = {
    'setup': {
        'description': 'ë„ë©”ì¸ ë””ë ‰í† ë¦¬ êµ¬ì¡° ë° í´ë˜ìŠ¤ ë§µ ì„¤ì •',
        'function': 'setup_domain',
        'dependencies': []
    },
    'split': {
        'description': 'ë°ì´í„°ì…‹ ë¶„í•  (train/validation/test)',
        'function': 'split_dataset',
        'dependencies': ['setup']
    },
    'augment': {
        'description': 'ë°ì´í„° ì¦ê°•',
        'function': 'augment_dataset',
        'dependencies': ['split']
    },
    'preprocess': {
        'description': 'ë°ì´í„° ì „ì²˜ë¦¬',
        'function': 'preprocess_dataset',
        'dependencies': ['augment']
    },
    'validate': {
        'description': 'ë°ì´í„°ì…‹ ê²€ì¦',
        'function': 'validate_dataset',
        'dependencies': ['preprocess']
    }
}

def run_dataset_pipeline(domain, config, stages=None):
    """ë°ì´í„°ì…‹ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰"""
    if stages is None:
        stages = list(DATASET_PIPELINE_STAGES.keys())
    
    results = {}
    
    for stage in stages:
        if stage not in DATASET_PIPELINE_STAGES:
            results[stage] = {'status': 'error', 'message': f'Unknown stage: {stage}'}
            continue
        
        stage_config = DATASET_PIPELINE_STAGES[stage]
        
        # ì˜ì¡´ì„± í™•ì¸
        for dependency in stage_config['dependencies']:
            if dependency not in results or results[dependency]['status'] != 'success':
                results[stage] = {'status': 'skipped', 'message': f'Dependency {dependency} failed'}
                continue
        
        try:
            function = globals()[stage_config['function']]
            result = function(domain, config)
            results[stage] = {'status': 'success', 'result': result}
            
        except Exception as e:
            results[stage] = {'status': 'error', 'message': str(e)}
    
    return results
```

## ğŸ” ì½”ë“œ í’ˆì§ˆ ìë™í™”

### ì½”ë“œ ìŠ¹ê²© ìë™í™”
```python
# scripts/development/code_promotion/ êµ¬í˜„ í‘œì¤€
CODE_PROMOTION_CRITERIA = {
    'reusability': {
        'description': 'ì—¬ëŸ¬ ëª¨ë“ˆì—ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥ì„±',
        'weight': 0.3,
        'threshold': 0.7,
        'analyzer': 'analyze_reusability'
    },
    'stability': {
        'description': 'ì½”ë“œì˜ ì•ˆì •ì„± ë° í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€',
        'weight': 0.25,
        'threshold': 0.8,
        'analyzer': 'analyze_stability'
    },
    'generality': {
        'description': 'ì½”ë“œì˜ ë²”ìš©ì„±',
        'weight': 0.25,
        'threshold': 0.7,
        'analyzer': 'analyze_generality'
    },
    'duplication': {
        'description': 'ì½”ë“œ ì¤‘ë³µ ì •ë„',
        'weight': 0.2,
        'threshold': 0.6,
        'analyzer': 'analyze_duplication'
    }
}

def analyze_promotion_candidate(file_path):
    """ì½”ë“œ ìŠ¹ê²© í›„ë³´ ë¶„ì„"""
    scores = {}
    
    # ì¬ì‚¬ìš©ì„± ë¶„ì„
    scores['reusability'] = analyze_reusability(file_path)
    
    # ì•ˆì •ì„± ë¶„ì„
    scores['stability'] = analyze_stability(file_path)
    
    # ë²”ìš©ì„± ë¶„ì„
    scores['generality'] = analyze_generality(file_path)
    
    # ì¤‘ë³µ ë¶„ì„
    scores['duplication'] = analyze_duplication(file_path)
    
    # ì´ì  ê³„ì‚°
    total_score = sum(
        scores[criterion] * config['weight']
        for criterion, config in CODE_PROMOTION_CRITERIA.items()
    )
    
    # ìŠ¹ê²© ìê²© íŒì •
    eligible = all(
        scores[criterion] >= config['threshold']
        for criterion, config in CODE_PROMOTION_CRITERIA.items()
    )
    
    return {
        'file_path': file_path,
        'total_score': total_score,
        'scores': scores,
        'eligible': eligible,
        'recommendation': 'promote' if eligible and total_score >= 0.7 else 'keep'
    }
```

## ğŸ¤– CI/CD íŒŒì´í”„ë¼ì¸

### GitHub Actions ì›Œí¬í”Œë¡œìš°
```yaml
# .github/workflows/vision-system-ci.yml
name: Vision System CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8 mypy bandit safety
        pip install -r requirements.txt
    
    - name: Code formatting with Black
      run: black --check .
    
    - name: Import sorting with isort
      run: isort --check-only .
    
    - name: Linting with flake8
      run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    
    - name: Type checking with mypy
      run: mypy domains/ shared/ common/
    
    - name: Security scan with bandit
      run: bandit -r domains/ shared/ common/ -f json -o bandit-report.json
    
    - name: Safety check for dependencies
      run: safety check

  test:
    runs-on: ubuntu-latest
    needs: lint-and-format
    strategy:
      matrix:
        python-version: [3.8, 3.9, 3.10]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-xdist
    
    - name: Run tests
      run: |
        pytest tests/ --cov=domains --cov=shared --cov=common --cov-report=xml
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml

  validate-structure:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Validate project structure
      run: |
        python scripts/validation/validate_project_structure.py
    
    - name: Validate rules compliance
      run: |
        python scripts/validation/validate_rules.py
```

### Pre-commit í›… ì„¤ì •
```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/psf/black
    rev: 23.3.0
    hooks:
      - id: black
        language_version: python3

  - repo: https://github.com/pycqa/isort
    rev: 5.12.0
    hooks:
      - id: isort
        args: ["--profile", "black"]

  - repo: https://github.com/pycqa/flake8
    rev: 6.0.0
    hooks:
      - id: flake8
        args: [--max-line-length=88, --extend-ignore=E203]

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.3.0
    hooks:
      - id: mypy
        additional_dependencies: [types-PyYAML, types-requests]

  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.5
    hooks:
      - id: bandit
        args: ["-r", "domains/", "shared/", "common/"]

  - repo: local
    hooks:
      - id: validate-structure
        name: Validate Project Structure
        entry: python scripts/validation/validate_project_structure.py
        language: system
        pass_filenames: false
```

## ğŸ”§ ê°œë°œ ë„êµ¬ ìë™ ì„¤ì •

### ì½”ë”© ë„êµ¬ ì„¤ì • ë° ì„¤ì¹˜
```python
# scripts/setup/setup_coding_tools.py
REQUIRED_TOOLS = {
    'black': {
        'version': '23.3.0',
        'purpose': 'Python ì½”ë“œ ìë™ í¬ë§·íŒ…',
        'config_file': 'pyproject.toml',
        'installation': 'pip install black==23.3.0'
    },
    'isort': {
        'version': '5.12.0',
        'purpose': 'Python import ë¬¸ ìë™ ì •ë ¬',
        'config_file': 'pyproject.toml',
        'installation': 'pip install isort==5.12.0'
    },
    'flake8': {
        'version': '6.0.0',
        'purpose': 'Python ì½”ë“œ ë¦°íŒ…',
        'config_file': '.flake8',
        'installation': 'pip install flake8==6.0.0'
    },
    'pylint': {
        'version': '2.17.0',
        'purpose': 'Python ì½”ë“œ ì •ì  ë¶„ì„',
        'config_file': '.pylintrc',
        'installation': 'pip install pylint==2.17.0'
    },
    'mypy': {
        'version': '1.3.0',
        'purpose': 'Python íƒ€ì… ì²´í‚¹',
        'config_file': 'pyproject.toml',
        'installation': 'pip install mypy==1.3.0'
    }
}

def setup_development_tools():
    """ê°œë°œ ë„êµ¬ ìë™ ì„¤ì¹˜ ë° ì„¤ì •"""
    for tool_name, tool_config in REQUIRED_TOOLS.items():
        install_tool(tool_name, tool_config)
        generate_config_file(tool_name, tool_config)

def install_tool(tool_name, tool_config):
    """ë„êµ¬ ì„¤ì¹˜"""
    print(f"Installing {tool_name}...")
    subprocess.run(tool_config['installation'].split(), check=True)
    print(f"âœ“ {tool_name} installed successfully")

def generate_config_file(tool_name, tool_config):
    """ì„¤ì • íŒŒì¼ ìƒì„±"""
    config_file = tool_config['config_file']
    
    if tool_name == 'black' and config_file == 'pyproject.toml':
        config_content = """
[tool.black]
line-length = 88
target-version = ['py38', 'py39', 'py310']
include = '\\.pyi?$'
extend-exclude = '''
/(
  # directories
  \\.eggs
  | \\.git
  | \\.mypy_cache
  | \\.tox
  | \\.venv
  | build
  | dist
)/
'''
"""
    elif tool_name == 'isort' and config_file == 'pyproject.toml':
        config_content = """
[tool.isort]
profile = "black"
multi_line_output = 3
line_length = 88
include_trailing_comma = true
sections = ["FUTURE", "STDLIB", "THIRDPARTY", "FIRSTPARTY", "LOCALFOLDER"]
known_first_party = ["domains", "shared", "common"]
"""
    elif tool_name == 'flake8' and config_file == '.flake8':
        config_content = """[flake8]
max-line-length = 88
extend-ignore = E203, E266, E501, W503
max-complexity = 18
select = B,C,E,F,W,T4,B9
exclude = 
    .git,
    __pycache__,
    .pytest_cache,
    .mypy_cache,
    .venv,
    build,
    dist
"""
    
    # ì„¤ì • íŒŒì¼ ì‘ì„± (ê¸°ì¡´ íŒŒì¼ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸)
    if config_content:
        with open(config_file, 'w') as f:
            f.write(config_content)
        print(f"âœ“ {config_file} generated for {tool_name}")
```

### Git í›… ìë™ ì„¤ì •
```python
# scripts/setup/setup_git_hooks.py
GIT_HOOKS = {
    'pre-commit': {
        'checks': ['validate_rules', 'code_style_check', 'docstring_check'],
        'script_content': '''#!/bin/sh
# Pre-commit hook for vision system

echo "Running pre-commit checks..."

# Code style check
python scripts/validation/check_code_style.py --auto-fix
if [ $? -ne 0 ]; then
    echo "âŒ Code style check failed"
    exit 1
fi

# Rules validation
python scripts/validation/validate_rules.py
if [ $? -ne 0 ]; then
    echo "âŒ Rules validation failed"
    exit 1
fi

echo "âœ“ All pre-commit checks passed"
exit 0
'''
    },
    'pre-push': {
        'checks': ['validate_rules', 'security_check'],
        'script_content': '''#!/bin/sh
# Pre-push hook for vision system

echo "Running pre-push checks..."

# Security check
bandit -r domains/ shared/ common/ -f json -o bandit-report.json
if [ $? -ne 0 ]; then
    echo "âŒ Security check failed"
    exit 1
fi

# Safety check
safety check
if [ $? -ne 0 ]; then
    echo "âŒ Dependency safety check failed"
    exit 1
fi

echo "âœ“ All pre-push checks passed"
exit 0
'''
    }
}

def setup_git_hooks():
    """Git í›… ìë™ ì„¤ì¹˜"""
    hooks_dir = ".git/hooks"
    
    if not os.path.exists(hooks_dir):
        print("Git repository not found")
        return
    
    for hook_name, hook_config in GIT_HOOKS.items():
        hook_path = os.path.join(hooks_dir, hook_name)
        
        with open(hook_path, 'w') as f:
            f.write(hook_config['script_content'])
        
        # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        os.chmod(hook_path, 0o755)
        
        print(f"âœ“ {hook_name} hook installed")
```

## ğŸ“Š ì½”ë“œ í’ˆì§ˆ ìë™ ê²€ì‚¬

### ì½”ë“œ ìŠ¤íƒ€ì¼ ìë™ ê²€ì‚¬
```python
# scripts/validation/check_code_style.py
def check_code_style(files=None, auto_fix=False):
    """
    ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ ìŠ¤í¬ë¦½íŠ¸
    
    Args:
        files: ê²€ì‚¬í•  íŒŒì¼ ëª©ë¡ (Noneì´ë©´ ì „ì²´)
        auto_fix: ìë™ ìˆ˜ì • ì—¬ë¶€
    
    Returns:
        ê²€ì‚¬ ê²°ê³¼ ë”•ì…”ë„ˆë¦¬
    """
    results = {}
    
    # Black ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬
    if auto_fix:
        result = subprocess.run(['black', '.'], capture_output=True, text=True)
        results['black'] = {'status': 'fixed', 'output': result.stdout}
    else:
        result = subprocess.run(['black', '--check', '.'], capture_output=True, text=True)
        results['black'] = {'passed': result.returncode == 0, 'output': result.stdout}
    
    # isort import ì •ë ¬ ê²€ì‚¬
    if auto_fix:
        result = subprocess.run(['isort', '.'], capture_output=True, text=True)
        results['isort'] = {'status': 'fixed', 'output': result.stdout}
    else:
        result = subprocess.run(['isort', '--check-only', '.'], capture_output=True, text=True)
        results['isort'] = {'passed': result.returncode == 0, 'output': result.stdout}
    
    # flake8 ë¦°íŒ… ê²€ì‚¬
    result = subprocess.run(['flake8', '.'], capture_output=True, text=True)
    results['flake8'] = {'passed': result.returncode == 0, 'output': result.stdout}
    
    # mypy íƒ€ì… ì²´í‚¹
    result = subprocess.run(['mypy', 'domains/', 'shared/', 'common/'], capture_output=True, text=True)
    results['mypy'] = {'passed': result.returncode == 0, 'output': result.stdout}
    
    return results

def generate_style_report(results):
    """ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ ë¦¬í¬íŠ¸ ìƒì„±"""
    report = {
        'timestamp': datetime.now().isoformat(),
        'results': results,
        'summary': {
            'total_checks': len(results),
            'passed': sum(1 for r in results.values() if r.get('passed', False)),
            'failed': sum(1 for r in results.values() if not r.get('passed', True))
        }
    }
    
    with open('data/runtime/logs/code_style_report.json', 'w') as f:
        json.dump(report, f, indent=2)
    
    return report
```

## ğŸ”„ ìë™ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸

### ìŠ¤í…Œì´ì§• ë°°í¬ ìë™í™”
```python
# scripts/deployment/deploy_staging.py
def deploy_to_staging(version_tag=None):
    """ìŠ¤í…Œì´ì§• í™˜ê²½ ë°°í¬"""
    
    # 1. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    style_results = check_code_style()
    if not all(r.get('passed', False) for r in style_results.values()):
        raise Exception("Code style checks failed")
    
    # 2. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    test_result = subprocess.run(['pytest', 'tests/', '--cov=domains'], capture_output=True)
    if test_result.returncode != 0:
        raise Exception("Tests failed")
    
    # 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ
    build_result = subprocess.run([
        'docker', 'build', 
        '-t', f'vision-system:staging-{version_tag or "latest"}',
        '.'
    ], capture_output=True)
    
    if build_result.returncode != 0:
        raise Exception("Docker build failed")
    
    # 4. ë°°í¬ ì‹¤í–‰
    deploy_result = subprocess.run([
        'docker', 'run', '-d',
        '--name', 'vision-system-staging',
        '-p', '8001:8000',
        f'vision-system:staging-{version_tag or "latest"}'
    ], capture_output=True)
    
    if deploy_result.returncode != 0:
        raise Exception("Deployment failed")
    
    print("âœ“ Staging deployment completed successfully")
    return True
```


---

**ì ìš© ì‹œì **: íŒ€ ê°œë°œ ì‹œì‘ ì‹œ ë˜ëŠ” ì½”ë“œ í’ˆì§ˆ ìë™í™”ê°€ í•„ìš”í•  ë•Œ
**ì˜ì¡´ì„±**: `pip install black isort flake8 mypy bandit safety pre-commit`
**ì„¤ì •**: GitHub Actions, pre-commit í›…, ì½”ë“œ í’ˆì§ˆ ë„êµ¬ ì„¤ì • í•„ìš”


