---
description: 
globs: 
alwaysApply: false
---
# ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ (ADVANCED)

## ðŸ“Š ì‹¤ì‹œê°„ ì„±ëŠ¥ ëŒ€ì‹œë³´ë“œ

### Prometheus & Grafana í†µí•©
```python
import time
import threading
from prometheus_client import Counter, Histogram, Gauge, start_http_server
from typing import Dict, List, Optional
import psutil
import GPUtil

class VisionSystemMetrics:
    """ë¹„ì „ ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ê¸°"""
    
    def __init__(self, port: int = 8000):
        self.port = port
        
        # ì¹´ìš´í„° ë©”íŠ¸ë¦­
        self.frame_processed_total = Counter(
            'vision_frames_processed_total',
            'Total number of frames processed',
            ['camera_id', 'model_type']
        )
        
        self.detection_total = Counter(
            'vision_detections_total',
            'Total number of detections',
            ['class_name', 'confidence_range']
        )
        
        self.error_total = Counter(
            'vision_errors_total',
            'Total number of errors',
            ['error_type', 'component']
        )
        
        # ížˆìŠ¤í† ê·¸ëž¨ ë©”íŠ¸ë¦­
        self.frame_processing_duration = Histogram(
            'vision_frame_processing_seconds',
            'Time spent processing frames',
            ['camera_id', 'model_type'],
            buckets=[0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1.0, 2.5, 5.0]
        )
        
        self.model_inference_duration = Histogram(
            'vision_model_inference_seconds',
            'Time spent on model inference',
            ['model_name', 'device'],
            buckets=[0.001, 0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5]
        )
        
        # ê²Œì´ì§€ ë©”íŠ¸ë¦­
        self.current_fps = Gauge(
            'vision_current_fps',
            'Current frames per second',
            ['camera_id']
        )
        
        self.gpu_memory_usage = Gauge(
            'vision_gpu_memory_usage_bytes',
            'GPU memory usage in bytes',
            ['gpu_id']
        )
        
        self.cpu_usage = Gauge(
            'vision_cpu_usage_percent',
            'CPU usage percentage'
        )
        
        self.memory_usage = Gauge(
            'vision_memory_usage_bytes',
            'Memory usage in bytes'
        )
        
        # ë¹„ì¦ˆë‹ˆìŠ¤ ë©”íŠ¸ë¦­
        self.defect_detection_rate = Gauge(
            'vision_defect_detection_rate',
            'Current defect detection rate',
            ['line_id', 'defect_type']
        )
        
        self.quality_score = Gauge(
            'vision_quality_score',
            'Overall quality score',
            ['metric_type']
        )
    
    def start_monitoring(self):
        """ëª¨ë‹ˆí„°ë§ ì‹œìž‘"""
        start_http_server(self.port)
        self.is_monitoring = True
        
        self.monitoring_thread = threading.Thread(
            target=self._monitoring_loop,
            daemon=True
        )
        self.monitoring_thread.start()
        
        logger.info(f"Prometheus metrics server started on port {self.port}")
    
    def record_frame_processed(self, camera_id: str, model_type: str, duration: float):
        """í”„ë ˆìž„ ì²˜ë¦¬ ê¸°ë¡"""
        self.frame_processed_total.labels(
            camera_id=camera_id, 
            model_type=model_type
        ).inc()
        
        self.frame_processing_duration.labels(
            camera_id=camera_id,
            model_type=model_type
        ).observe(duration)
```

### Grafana ëŒ€ì‹œë³´ë“œ ì„¤ì •
```yaml
# grafana_dashboard_config.yaml
dashboard:
  title: "Vision System Monitoring"
  panels:
    - title: "System Overview"
      type: "stat"
      targets:
        - expr: "vision_current_fps"
          legendFormat: "FPS - {{ camera_id }}"
        - expr: "vision_active_cameras"
          legendFormat: "Active Cameras"
        - expr: "rate(vision_frames_processed_total[5m])"
          legendFormat: "Processing Rate"
    
    - title: "Performance Metrics"
      type: "graph"
      targets:
        - expr: "histogram_quantile(0.95, vision_frame_processing_seconds_bucket)"
          legendFormat: "95th percentile processing time"
        - expr: "histogram_quantile(0.50, vision_frame_processing_seconds_bucket)"
          legendFormat: "50th percentile processing time"
    
    - title: "Resource Usage"
      type: "graph"
      targets:
        - expr: "vision_cpu_usage_percent"
          legendFormat: "CPU Usage %"
        - expr: "vision_memory_usage_bytes / 1024 / 1024 / 1024"
          legendFormat: "Memory Usage GB"
        - expr: "vision_gpu_memory_usage_bytes / 1024 / 1024 / 1024"
          legendFormat: "GPU Memory GB - {{ gpu_id }}"

alerts:
  - name: "High Error Rate"
    condition: "rate(vision_errors_total[5m]) > 0.1"
    severity: "warning"
    
  - name: "Low FPS"
    condition: "vision_current_fps < 15"
    severity: "critical"
    
  - name: "High GPU Memory Usage"
    condition: "vision_gpu_memory_usage_bytes / 1024 / 1024 / 1024 > 6"
    severity: "warning"
```

## ðŸš¨ ì´ìƒ ê°ì§€ ë° ìžë™ ì•Œë¦¼

### ì´ìƒ ê°ì§€ ì‹œìŠ¤í…œ
```python
import numpy as np
from sklearn.ensemble import IsolationForest
from collections import deque

class AnomalyDetector:
    """ì´ìƒ ê°ì§€ ì‹œìŠ¤í…œ"""
    
    def __init__(self, window_size: int = 100):
        self.window_size = window_size
        self.metrics_history = {
            'fps': deque(maxlen=window_size),
            'processing_time': deque(maxlen=window_size),
            'gpu_memory': deque(maxlen=window_size),
            'detection_count': deque(maxlen=window_size)
        }
        
        # ì´ìƒ ê°ì§€ ëª¨ë¸
        self.models = {}
        self._initialize_models()
        
        # ìž„ê³„ê°’ ì„¤ì •
        self.thresholds = {
            'fps_min': 15.0,
            'fps_max': 60.0,
            'processing_time_max': 0.1,  # 100ms
            'gpu_memory_max': 0.9,       # 90%
            'detection_count_min': 0,
            'detection_count_max': 100
        }
    
    def _initialize_models(self):
        """ì´ìƒ ê°ì§€ ëª¨ë¸ ì´ˆê¸°í™”"""
        for metric_name in self.metrics_history.keys():
            self.models[metric_name] = IsolationForest(
                contamination=0.1,  # 10% ì´ìƒì¹˜ í—ˆìš©
                random_state=42
            )
    
    def add_metric(self, metric_name: str, value: float):
        """ë©”íŠ¸ë¦­ ì¶”ê°€ ë° ì´ìƒ ê°ì§€"""
        if metric_name not in self.metrics_history:
            return
        
        self.metrics_history[metric_name].append(value)
        
        # ì¶©ë¶„í•œ ë°ì´í„°ê°€ ìŒ“ì´ë©´ ì´ìƒ ê°ì§€ ìˆ˜í–‰
        if len(self.metrics_history[metric_name]) >= 50:
            self._detect_anomaly(metric_name, value)
    
    def _detect_anomaly(self, metric_name: str, current_value: float):
        """ì´ìƒ ê°ì§€ ìˆ˜í–‰"""
        history = list(self.metrics_history[metric_name])
        
        # ëª¨ë¸ í›ˆë ¨ (ìµœê·¼ ë°ì´í„°ë¡œ)
        if len(history) >= 50:
            X = np.array(history[:-1]).reshape(-1, 1)
            self.models[metric_name].fit(X)
            
            # í˜„ìž¬ ê°’ ì´ìƒ ê°ì§€
            current_X = np.array([[current_value]])
            anomaly_score = self.models[metric_name].decision_function(current_X)[0]
            is_anomaly = self.models[metric_name].predict(current_X)[0] == -1
            
            if is_anomaly:
                self._handle_anomaly(metric_name, current_value, anomaly_score)
```

## ðŸ“ˆ ë¹„ì¦ˆë‹ˆìŠ¤ ë©”íŠ¸ë¦­ ì¶”ì 

### í’ˆì§ˆ ê´€ë¦¬ ë©”íŠ¸ë¦­
```python
class QualityMetricsTracker:
    """í’ˆì§ˆ ê´€ë¦¬ ë©”íŠ¸ë¦­ ì¶”ì ê¸°"""
    
    def __init__(self):
        self.metrics_buffer = {
            'defect_detections': deque(maxlen=1000),
            'false_positives': deque(maxlen=1000),
            'false_negatives': deque(maxlen=1000),
            'processing_times': deque(maxlen=1000)
        }
        
        self.quality_targets = {
            'defect_rate_max': 0.05,    # 5% ìµœëŒ€ ë¶ˆëŸ‰ë¥ 
            'accuracy_min': 0.95,       # 95% ìµœì†Œ ì •í™•ë„
            'precision_min': 0.90,      # 90% ìµœì†Œ ì •ë°€ë„
            'recall_min': 0.85,         # 85% ìµœì†Œ ìž¬í˜„ìœ¨
            'throughput_min': 100       # ì‹œê°„ë‹¹ ìµœì†Œ 100ê°œ ì²˜ë¦¬
        }
    
    def calculate_quality_metrics(self, window_hours: float = 1.0) -> Dict:
        """í’ˆì§ˆ ë©”íŠ¸ë¦­ ê³„ì‚°"""
        cutoff_time = time.time() - (window_hours * 3600)
        
        # ìœˆë„ìš° ë‚´ ë°ì´í„° í•„í„°ë§
        recent_detections = [
            d for d in self.metrics_buffer['defect_detections']
            if d['timestamp'] > cutoff_time
        ]
        
        if not recent_detections:
            return {}
        
        # ê¸°ë³¸ ë©”íŠ¸ë¦­ ê³„ì‚°
        total_count = len(recent_detections)
        true_positives = sum(1 for d in recent_detections if d['actual'] and d['predicted'])
        false_positives = sum(1 for d in recent_detections if not d['actual'] and d['predicted'])
        false_negatives = sum(1 for d in recent_detections if d['actual'] and not d['predicted'])
        true_negatives = total_count - true_positives - false_positives - false_negatives
        
        # í’ˆì§ˆ ì§€í‘œ ê³„ì‚°
        accuracy = (true_positives + true_negatives) / total_count if total_count > 0 else 0
        precision = true_positives / (true_positives + false_positives) if (true_positives + false_positives) > 0 else 0
        recall = true_positives / (true_positives + false_negatives) if (true_positives + false_negatives) > 0 else 0
        f1_score = 2 * (precision * recall) / (precision + recall) if (precision + recall) > 0 else 0
        
        return {
            'accuracy': accuracy,
            'precision': precision,
            'recall': recall,
            'f1_score': f1_score,
            'total_processed': total_count
        }
```

## ðŸ“ ê³ ê¸‰ ë¡œê¹… ì‹œìŠ¤í…œ

### êµ¬ì¡°í™”ëœ ë¡œê¹…
```python
import structlog
import json
from pythonjsonlogger import jsonlogger

class VisionSystemLogger:
    """ë¹„ì „ ì‹œìŠ¤í…œ ì „ìš© êµ¬ì¡°í™” ë¡œê¹…"""
    
    def __init__(self):
        self.setup_structured_logging()
        
    def setup_structured_logging(self):
        """êµ¬ì¡°í™” ë¡œê¹… ì„¤ì •"""
        
        # JSON í¬ë§·í„° ì„¤ì •
        json_formatter = jsonlogger.JsonFormatter(
            fmt='%(asctime)s %(name)s %(levelname)s %(message)s',
            datefmt='%Y-%m-%d %H:%M:%S'
        )
        
        # í•¸ë“¤ëŸ¬ ì„¤ì •
        handlers = {
            'console': logging.StreamHandler(),
            'file': logging.FileHandler('data/runtime/logs/vision_system.json'),
            'performance_file': logging.FileHandler('data/runtime/logs/performance.json'),
            'business_file': logging.FileHandler('data/runtime/logs/business_metrics.json')
        }
        
        # ê° í•¸ë“¤ëŸ¬ì— JSON í¬ë§·í„° ì ìš©
        for handler in handlers.values():
            handler.setFormatter(json_formatter)
        
        # ë¡œê±° ì„¤ì •
        self.loggers = {
            'system': self._create_logger('vision.system', [handlers['console'], handlers['file']]),
            'performance': self._create_logger('vision.performance', [handlers['performance_file']]),
            'business': self._create_logger('vision.business', [handlers['business_file']])
        }
    
    def log_frame_processing(self, 
                           camera_id: str, 
                           frame_id: int, 
                           processing_time: float,
                           detections: List[Dict],
                           model_info: Dict):
        """í”„ë ˆìž„ ì²˜ë¦¬ ë¡œê¹…"""
        
        log_data = {
            'event_type': 'frame_processing',
            'camera_id': camera_id,
            'frame_id': frame_id,
            'processing_time_ms': processing_time * 1000,
            'detection_count': len(detections),
            'detections': detections,
            'model_name': model_info.get('name'),
            'model_version': model_info.get('version'),
            'device': model_info.get('device')
        }
        
        self.loggers['performance'].info(
            "Frame processed",
            extra=log_data
        )
    
    def log_business_metric(self, 
                          metric_name: str,
                          value: float,
                          unit: str,
                          context: Dict):
        """ë¹„ì¦ˆë‹ˆìŠ¤ ë©”íŠ¸ë¦­ ë¡œê¹…"""
        
        log_data = {
            'event_type': 'business_metric',
            'metric_name': metric_name,
            'value': value,
            'unit': unit,
            'context': context
        }
        
        self.loggers['business'].info(
            f"Business metric: {metric_name}",
            extra=log_data
        )
```

## ðŸ”§ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ì„¤ì¹˜ ë° ì„¤ì •

### ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸
```bash
#!/bin/bash
# scripts/setup_monitoring.sh

echo "Setting up monitoring system..."

# Prometheus ì„¤ì¹˜
wget https://github.com/prometheus/prometheus/releases/download/v2.40.0/prometheus-2.40.0.linux-amd64.tar.gz
tar xvf prometheus-2.40.0.linux-amd64.tar.gz
sudo mv prometheus-2.40.0.linux-amd64 /opt/prometheus

# Grafana ì„¤ì¹˜
sudo apt-get install -y software-properties-common
sudo add-apt-repository "deb https://packages.grafana.com/oss/deb stable main"
wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
sudo apt-get update
sudo apt-get install grafana

# Python ì˜ì¡´ì„± ì„¤ì¹˜
pip install prometheus-client psutil GPUtil structlog python-json-logger

echo "Monitoring system setup completed"
```

### Prometheus ì„¤ì •
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'vision-system'
    static_configs:
      - targets: ['localhost:8000']
    scrape_interval: 5s
    metrics_path: /metrics

rule_files:
  - "vision_alerts.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
```

### ì•Œë¦¼ ê·œì¹™
```yaml
# vision_alerts.yml
groups:
- name: vision_system_alerts
  rules:
  - alert: HighErrorRate
    expr: rate(vision_errors_total[5m]) > 0.1
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "High error rate detected"
      description: "Error rate is {{ $value }} errors per second"

  - alert: LowFPS
    expr: vision_current_fps < 15
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Low FPS detected"
      description: "FPS is {{ $value }} on camera {{ $labels.camera_id }}"
```


---

**ì ìš© ì‹œì **: factory_defect ë„ë©”ì¸ ì¶”ê°€ ì‹œ ë˜ëŠ” ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ì´ í•„ìš”í•  ë•Œ
**ì˜ì¡´ì„±**: `pip install prometheus-client psutil GPUtil structlog python-json-logger`
**ì„¤ì •**: Prometheus + Grafana ì„œë²„ êµ¬ì¶• í•„ìš”


