---
description: 
globs: 
alwaysApply: false
---
# ê¸°ë³¸ ë°ì´í„° ê´€ë¦¬ ê·œì¹™

## âš ï¸ í˜„ì‹¤ì  í•œê³„ ë° ì ìš© ì•ˆë‚´
- **ìë™ ì •ë¦¬ ì‹œìŠ¤í…œ**: ê¸°ë³¸ êµ¬í˜„ì€ ì œê³µë˜ì§€ë§Œ, ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” cron jobì´ë‚˜ ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì • í•„ìš”
- **ë©”íƒ€ë°ì´í„° ì €ì¥**: JSON í˜•íƒœë¡œ ì €ì¥ë˜ë©°, ì‹¤ì œ DB ì—°ë™ì€ ë³„ë„ êµ¬í˜„ í•„ìš”
- **ë³´ì¡´ ì •ì±…**: ê¸°ë³¸ê°’ì€ 24ì‹œê°„(ì„ì‹œ), 30ì¼(ë¡œê·¸)ì´ë©°, í”„ë¡œì íŠ¸ ìš”êµ¬ì‚¬í•­ì— ë”°ë¼ ì¡°ì • ê°€ëŠ¥

## ğŸ“‚ ë°ì´í„° í´ë” êµ¬ì¡°

### ê¸°ë³¸ ë°ì´í„° ì €ì¥ ìœ„ì¹˜ (ì‹¤ì œ í”„ë¡œì íŠ¸ êµ¬ì¡°ì™€ ì¼ì¹˜)
```
data/
â”œâ”€â”€ temp/                 # ì„ì‹œ íŒŒì¼ (ìë™ ì •ë¦¬, 24ì‹œê°„ ë³´ê´€)
â”œâ”€â”€ logs/                 # ë¡œê·¸ íŒŒì¼ (30ì¼ ë³´ê´€)
â”œâ”€â”€ output/               # ê²°ê³¼ë¬¼ ì €ì¥
â””â”€â”€ domains/              # ë„ë©”ì¸ë³„ ë°ì´í„°
    â””â”€â”€ face_recognition/ # ì–¼êµ´ì¸ì‹ ë„ë©”ì¸ ë°ì´í„°
        â”œâ”€â”€ detected_faces/
        â”œâ”€â”€ processed/
        â””â”€â”€ raw_input/
```

### datasets/ vs data/ êµ¬ë¶„ ì›ì¹™
```python
# datasets/ = í•™ìŠµ ì „ìš© (ê³ ì • ë°ì´í„°)
DATASETS_PURPOSE = {
    'raw/': 'ì›ë³¸ í•™ìŠµ ë°ì´í„° (ì´ë¯¸ì§€, ë¹„ë””ì˜¤)',
    'processed/': 'ì „ì²˜ë¦¬ëœ í•™ìŠµ ë°ì´í„°',
    'annotations/': 'ë¼ë²¨ë§ ë°ì´í„° (JSON, CSV)',
    'splits/': 'train/validation/test ë¶„í•  ì •ë³´'
}

# data/ = ëŸ°íƒ€ì„ ì „ìš© (ë™ì  ë°ì´í„°)
DATA_PURPOSE = {
    'temp/': 'ì„ì‹œ íŒŒì¼ (24ì‹œê°„ ìë™ ì •ë¦¬)',
    'logs/': 'ì‹œìŠ¤í…œ ë¡œê·¸ (30ì¼ ë³´ê´€)',
    'output/': 'ì²˜ë¦¬ ê²°ê³¼ë¬¼',
    'domains/': 'ë„ë©”ì¸ë³„ ì²˜ë¦¬ ë°ì´í„°'
}
```

## ğŸ“ íŒŒì¼ ë„¤ì´ë° ê·œì¹™

### ê¸°ë³¸ íŒŒì¼ ë„¤ì´ë° íŒ¨í„´
```python
FILE_NAMING_PATTERNS = {
    'logs': 'data/logs/{component}_{date}.log',
    'temp': 'data/temp/temp_{purpose}_{timestamp}.{ext}',
    'output': 'data/output/{purpose}_{date}.{ext}',
    'captured': 'data/domains/face_recognition/raw_input/captured/captured_frame_{timestamp}.{ext}',
    'detected': 'data/domains/face_recognition/detected_faces/{source}/face_{timestamp}_{confidence}.{ext}'
}

# ì˜ˆì‹œ
EXAMPLES = {
    'log_file': 'data/logs/face_recognition_20250702.log',
    'temp_image': 'data/temp/temp_aligned_20250702_143022.jpg',
    'captured_frame': 'data/domains/face_recognition/raw_input/captured/captured_frame_20250702_143022.jpg',
    'detected_face': 'data/domains/face_recognition/detected_faces/auto_collected/face_20250702_143022_conf0.95.jpg'
}
```

### íƒ€ì„ìŠ¤íƒ¬í”„ í˜•ì‹
```python
import datetime

def generate_timestamp() -> str:
    """í‘œì¤€ íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„±"""
    return datetime.now().strftime('%Y%m%d_%H%M%S_%f')[:-3]  # ë°€ë¦¬ì´ˆ í¬í•¨

def generate_date() -> str:
    """ë‚ ì§œ í˜•ì‹ ìƒì„±"""
    return datetime.now().strftime('%Y%m%d')

# ì‚¬ìš© ì˜ˆì‹œ
timestamp = generate_timestamp()  # '20250702_143022_123'
date = generate_date()           # '20250702'
```

## ğŸ—‚ï¸ ë°ì´í„° ì €ì¥ í•¨ìˆ˜

### í‘œì¤€ íŒŒì¼ ì €ì¥ í•¨ìˆ˜
```python
import os
import json
import cv2
from pathlib import Path

def save_image_with_metadata(
    image: np.ndarray,
    metadata: Dict,
    base_path: str,
    filename_prefix: str
) -> Tuple[str, str]:
    """ì´ë¯¸ì§€ì™€ ë©”íƒ€ë°ì´í„°ë¥¼ í•¨ê»˜ ì €ì¥"""
    
    # í´ë” ìƒì„±
    Path(base_path).mkdir(parents=True, exist_ok=True)
    
    # íŒŒì¼ëª… ìƒì„±
    timestamp = generate_timestamp()
    image_filename = f"{filename_prefix}_{timestamp}.jpg"
    metadata_filename = f"{filename_prefix}_{timestamp}.json"
    
    # ì „ì²´ ê²½ë¡œ
    image_path = os.path.join(base_path, image_filename)
    metadata_path = os.path.join(base_path, metadata_filename)
    
    # ì´ë¯¸ì§€ ì €ì¥
    cv2.imwrite(image_path, image)
    
    # ë©”íƒ€ë°ì´í„° ì €ì¥
    metadata['timestamp'] = timestamp
    metadata['image_path'] = image_path
    
    with open(metadata_path, 'w', encoding='utf-8') as f:
        json.dump(metadata, f, indent=2, ensure_ascii=False)
    
    return image_path, metadata_path
```

### ìº¡ì²˜ëœ í”„ë ˆì„ ì €ì¥
```python
def save_captured_frame(frame: np.ndarray, source_info: Dict) -> str:
    """ìº¡ì²˜ëœ í”„ë ˆì„ ì €ì¥"""
    base_path = "data/domains/face_recognition/raw_input/captured"
    
    metadata = {
        'source': source_info.get('source', 'unknown'),
        'resolution': f"{frame.shape[1]}x{frame.shape[0]}",
        'channels': frame.shape[2] if len(frame.shape) > 2 else 1,
        'capture_method': source_info.get('method', 'manual')
    }
    
    image_path, metadata_path = save_image_with_metadata(
        frame, metadata, base_path, "captured_frame"
    )
    
    return image_path
```

### ê²€ì¶œëœ ì–¼êµ´ ì €ì¥
```python
def save_detected_face(
    face_image: np.ndarray,
    detection_info: Dict,
    source: str = "auto_collected"
) -> str:
    """ê²€ì¶œëœ ì–¼êµ´ ì €ì¥"""
    base_path = f"data/domains/face_recognition/detected_faces/{source}"
    
    confidence = detection_info.get('confidence', 0.0)
    filename_prefix = f"face_conf{confidence:.2f}"
    
    metadata = {
        'confidence': confidence,
        'bbox': detection_info.get('bbox', []),
        'landmarks': detection_info.get('landmarks', []),
        'quality_score': detection_info.get('quality_score', 0.0),
        'source': source
    }
    
    image_path, metadata_path = save_image_with_metadata(
        face_image, metadata, base_path, filename_prefix
    )
    
    return image_path
```

## ğŸ§¹ ì„ì‹œ ë°ì´í„° ê´€ë¦¬

### ìë™ ì •ë¦¬ ê·œì¹™
```python
import time
import os
from pathlib import Path

class TempDataCleaner:
    """ì„ì‹œ ë°ì´í„° ìë™ ì •ë¦¬"""
    
    def __init__(self, temp_dir: str = "data/temp"):
        self.temp_dir = Path(temp_dir)
        self.max_age_hours = 24  # 24ì‹œê°„ ì´ìƒ ëœ íŒŒì¼ ì‚­ì œ
        self.max_size_mb = 500   # 500MB ì´ìƒ ì‹œ ì •ë¦¬
    
    def cleanup_old_files(self):
        """ì˜¤ë˜ëœ ì„ì‹œ íŒŒì¼ ì •ë¦¬"""
        if not self.temp_dir.exists():
            return
        
        current_time = time.time()
        max_age_seconds = self.max_age_hours * 3600
        deleted_count = 0
        
        for file_path in self.temp_dir.rglob("*"):
            if file_path.is_file():
                file_age = current_time - file_path.stat().st_mtime
                if file_age > max_age_seconds:
                    try:
                        file_path.unlink()
                        deleted_count += 1
                    except Exception as e:
                        logger.warning(f"Failed to delete {file_path}: {e}")
        
        if deleted_count > 0:
            logger.info(f"Cleaned up {deleted_count} old temporary files")
```

## ğŸ”§ ì‹¤ì œ ì ìš© ì˜ˆì‹œ

### ë°ëª¨ì—ì„œ ë°ì´í„° ì €ì¥ ì‚¬ìš©
```python
def run_demo_with_data_saving():
    """ë°ì´í„° ì €ì¥ê³¼ í•¨ê»˜ ë°ëª¨ ì‹¤í–‰"""
    temp_cleaner = TempDataCleaner()
    
    try:
        while True:
            ret, frame = cap.read()
            if not ret:
                break
            
            # ì–¼êµ´ ê²€ì¶œ
            detection_result = detection_service.detect_faces(frame)
            
            # ê²€ì¶œëœ ì–¼êµ´ ì €ì¥
            for face in detection_result.faces:
                face_image = extract_face_region(frame, face.bbox)
                save_detected_face(
                    face_image, 
                    {
                        'confidence': face.confidence.value,
                        'bbox': [face.bbox.x, face.bbox.y, face.bbox.width, face.bbox.height]
                    },
                    source="demo_capture"
                )
            
            # í”„ë ˆì„ ì €ì¥ (ì„ íƒì )
            if save_frame_requested:
                save_captured_frame(frame, {'source': 'demo', 'method': 'manual'})
                
    finally:
        # ì„ì‹œ íŒŒì¼ ì •ë¦¬
        temp_cleaner.cleanup_old_files()
```

## ğŸ“‹ ë°ì´í„° ê´€ë¦¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

### í•„ìˆ˜ êµ¬í˜„ í•­ëª©
- [ ] ë°ì´í„° í´ë” êµ¬ì¡° ìƒì„±
- [ ] íŒŒì¼ ë„¤ì´ë° ê·œì¹™ ì ìš©
- [ ] ë©”íƒ€ë°ì´í„° ì €ì¥ í•¨ìˆ˜ êµ¬í˜„
- [ ] ì„ì‹œ íŒŒì¼ ìë™ ì •ë¦¬ ì‹œìŠ¤í…œ

### ê¶Œì¥ êµ¬í˜„ í•­ëª©
- [ ] ë°ì´í„° í’ˆì§ˆ ê²€ì¦
- [ ] ë°±ì—… ì‹œìŠ¤í…œ
- [ ] ë°ì´í„° ì••ì¶•
- [ ] ì ‘ê·¼ ê¶Œí•œ ê´€ë¦¬

### ì„ íƒì  êµ¬í˜„ í•­ëª©
- [ ] ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™
- [ ] í´ë¼ìš°ë“œ ì €ì¥ì†Œ ì—°ë™
- [ ] ë°ì´í„° ë²„ì „ ê´€ë¦¬
- [ ] ìë™ ë°±ì—… ìŠ¤ì¼€ì¤„ë§

---

**ì ìš© ìš°ì„ ìˆœìœ„**:
1. íŒŒì¼ ì €ì¥ ìœ„ì¹˜ ì¤€ìˆ˜ (í•„ìˆ˜)
2. íŒŒì¼ ë„¤ì´ë° ê·œì¹™ (í•„ìˆ˜)
3. ë©”íƒ€ë°ì´í„° ì €ì¥ (ê¶Œì¥)
4. ìë™ ì •ë¦¬ ì‹œìŠ¤í…œ (ì„ íƒì )






