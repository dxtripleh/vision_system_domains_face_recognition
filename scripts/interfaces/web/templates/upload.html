{% extends "base.html" %}

{% block title %}이미지 분석 - 얼굴인식 시스템{% endblock %}

{% block content %}
<div id="alerts"></div>

<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="fas fa-upload text-primary"></i>
            이미지 분석
        </h2>
        <p class="text-muted">이미지를 업로드하여 얼굴을 검출하고 인식해보세요.</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cloud-upload-alt"></i>
                    이미지 업로드
                </h5>
            </div>
            <div class="card-body">
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <h5>이미지를 드래그하거나 클릭하여 선택하세요</h5>
                    <p class="text-muted">지원 형식: JPG, PNG, BMP, GIF (최대 16MB)</p>
                    
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    <button class="btn btn-primary" onclick="$('#imageInput').click()">
                        <i class="fas fa-folder-open"></i>
                        파일 선택
                    </button>
                </div>
                
                <div class="loading-spinner text-center mt-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">처리 중...</span>
                    </div>
                    <p class="mt-2">이미지를 분석하고 있습니다...</p>
                </div>
            </div>
        </div>
        
        <!-- 업로드된 이미지 미리보기 -->
        <div class="card mt-3" id="previewCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-eye"></i>
                    업로드된 이미지
                </h5>
            </div>
            <div class="card-body text-center">
                <img id="previewImage" class="img-fluid rounded" style="max-height: 400px;">
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <!-- 분석 결과 -->
        <div class="card" id="resultsCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-search"></i>
                    분석 결과
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-6">
                        <div class="stats-card card text-center p-3">
                            <i class="fas fa-users fa-2x mb-2"></i>
                            <h5 id="detectedFaces">0</h5>
                            <small>검출된 얼굴</small>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="stats-card card text-center p-3">
                            <i class="fas fa-user-check fa-2x mb-2"></i>
                            <h5 id="recognizedFaces">0</h5>
                            <small>인식된 얼굴</small>
                        </div>
                    </div>
                </div>
                
                <div id="faceResults"></div>
            </div>
        </div>
        
        <!-- 얼굴 등록 카드 -->
        <div class="card mt-3" id="registerCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-user-plus"></i>
                    얼굴 등록
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">인식되지 않은 얼굴을 새로운 인물로 등록할 수 있습니다.</p>
                
                <div class="mb-3">
                    <label for="personSelect" class="form-label">등록할 인물 선택</label>
                    <select class="form-select" id="personSelect">
                        <option value="">인물을 선택하세요...</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="selectedFace" class="form-label">등록할 얼굴 선택</label>
                    <div id="faceSelector"></div>
                </div>
                
                <button class="btn btn-success" onclick="registerSelectedFace()" id="registerBtn" disabled>
                    <i class="fas fa-save"></i>
                    얼굴 등록
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let uploadedResults = null;
    let selectedFaceData = null;
    
    $(document).ready(function() {
        setupUploadHandlers();
        loadPersonsList();
    });
    
    function setupUploadHandlers() {
        const uploadArea = $('#uploadArea');
        const imageInput = $('#imageInput');
        
        // 클릭으로 파일 선택
        uploadArea.on('click', function() {
            imageInput.click();
        });
        
        // 드래그 앤 드롭
        uploadArea.on('dragover', function(e) {
            e.preventDefault();
            uploadArea.addClass('dragover');
        });
        
        uploadArea.on('dragleave', function(e) {
            e.preventDefault();
            uploadArea.removeClass('dragover');
        });
        
        uploadArea.on('drop', function(e) {
            e.preventDefault();
            uploadArea.removeClass('dragover');
            
            const files = e.originalEvent.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });
        
        // 파일 입력 변경
        imageInput.on('change', function(e) {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });
    }
    
    function handleFileSelect(file) {
        // 파일 유효성 검사
        if (!file.type.startsWith('image/')) {
            showAlert('이미지 파일만 업로드할 수 있습니다.', 'warning');
            return;
        }
        
        if (file.size > 16 * 1024 * 1024) {
            showAlert('파일 크기는 16MB를 초과할 수 없습니다.', 'warning');
            return;
        }
        
        // 미리보기 표시
        const reader = new FileReader();
        reader.onload = function(e) {
            $('#previewImage').attr('src', e.target.result);
            $('#previewCard').show();
        };
        reader.readAsDataURL(file);
        
        // 파일 업로드
        uploadFile(file);
    }
    
    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        
        showLoading();
        
        $.ajax({
            url: '/api/upload',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                hideLoading();
                
                if (response.success) {
                    displayResults(response);
                } else {
                    showAlert('이미지 처리에 실패했습니다.', 'danger');
                }
            },
            error: function(xhr) {
                hideLoading();
                const error = xhr.responseJSON?.error || '서버 오류가 발생했습니다.';
                showAlert(error, 'danger');
            }
        });
    }
    
    function displayResults(results) {
        uploadedResults = results;
        
        // 통계 업데이트
        $('#detectedFaces').text(results.total_faces);
        
        let recognizedCount = 0;
        results.detections.forEach(detection => {
            if (detection.recognition && detection.recognition.similarity >= 0.6) {
                recognizedCount++;
            }
        });
        $('#recognizedFaces').text(recognizedCount);
        
        // 개별 얼굴 결과 표시
        const faceResultsHtml = results.detections.map((detection, index) => {
            const isRecognized = detection.recognition && detection.recognition.similarity >= 0.6;
            const cardClass = isRecognized ? 'border-success' : 'border-warning';
            
            return `
                <div class="face-detection-result ${cardClass}">
                    <div class="row">
                        <div class="col-md-4">
                            <img src="${detection.face_image}" class="face-image img-fluid">
                        </div>
                        <div class="col-md-8">
                            <h6>얼굴 #${index + 1}</h6>
                            <p><strong>검출 신뢰도:</strong> ${(detection.confidence * 100).toFixed(1)}%</p>
                            
                            ${isRecognized ? `
                                <div class="text-success">
                                    <i class="fas fa-check-circle"></i>
                                    <strong>인식됨:</strong> ${detection.recognition.person_name}
                                    <br>
                                    <small>유사도: ${(detection.recognition.similarity * 100).toFixed(1)}%</small>
                                </div>
                            ` : `
                                <div class="text-warning">
                                    <i class="fas fa-question-circle"></i>
                                    <strong>미인식</strong>
                                    <br>
                                    <button class="btn btn-sm btn-outline-primary mt-2" 
                                            onclick="selectFaceForRegistration(${index})">
                                        등록하기
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        $('#faceResults').html(faceResultsHtml);
        $('#resultsCard').show();
        
        // 미인식 얼굴이 있으면 등록 카드 표시
        if (recognizedCount < results.total_faces) {
            $('#registerCard').show();
        }
    }
    
    function selectFaceForRegistration(faceIndex) {
        selectedFaceData = uploadedResults.detections[faceIndex];
        
        // 얼굴 선택기 업데이트
        const faceSelectorHtml = `
            <div class="text-center">
                <img src="${selectedFaceData.face_image}" class="face-image img-fluid">
                <p class="mt-2"><strong>선택된 얼굴 #${faceIndex + 1}</strong></p>
            </div>
        `;
        
        $('#faceSelector').html(faceSelectorHtml);
        
        // 등록 버튼 활성화 조건 확인
        updateRegisterButton();
    }
    
    function loadPersonsList() {
        $.ajax({
            url: '/api/persons',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const options = response.persons.map(person => 
                        `<option value="${person.person_id}">${person.name}</option>`
                    ).join('');
                    
                    $('#personSelect').html(`
                        <option value="">인물을 선택하세요...</option>
                        ${options}
                    `);
                }
            }
        });
        
        // 인물 선택 변경 시 버튼 상태 업데이트
        $('#personSelect').on('change', updateRegisterButton);
    }
    
    function updateRegisterButton() {
        const personSelected = $('#personSelect').val();
        const faceSelected = selectedFaceData !== null;
        
        $('#registerBtn').prop('disabled', !(personSelected && faceSelected));
    }
    
    function registerSelectedFace() {
        const personId = $('#personSelect').val();
        
        if (!personId || !selectedFaceData) {
            showAlert('인물과 얼굴을 모두 선택해주세요.', 'warning');
            return;
        }
        
        const data = {
            person_id: personId,
            image_data: selectedFaceData.face_image
        };
        
        $.ajax({
            url: '/api/register_face',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.success) {
                    showAlert('얼굴이 성공적으로 등록되었습니다.', 'success');
                    
                    // 선택 상태 초기화
                    selectedFaceData = null;
                    $('#faceSelector').empty();
                    $('#personSelect').val('');
                    updateRegisterButton();
                } else {
                    showAlert('얼굴 등록에 실패했습니다.', 'danger');
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || '서버 오류가 발생했습니다.';
                showAlert(error, 'danger');
            }
        });
    }
</script>
{% endblock %} 